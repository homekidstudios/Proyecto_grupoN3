<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Gastos Personales - Proyecto Grupo 03</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Chosen Palette: Warm Professional -->
    <!-- Primary: Slate-800 (Text), Background: Amber-50/Stone-50 -->
    <!-- Accents: Emerald-600 (Control), Amber-500 (Alert), Rose-600 (Excess) -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafaf9; /* Stone-50 */
            color: #1e293b; /* Slate-800 */
        }

        /* Chart Container Styling - MANDATORY */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Mobile default */
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px; /* Tablet/Desktop */
            }
        }

        /* Flowchart Connector Styles */
        .flow-arrow::after {
            content: '↓';
            display: block;
            text-align: center;
            font-size: 1.5rem;
            color: #94a3b8;
            margin: 0.5rem 0;
        }

        .flow-box {
            transition: all 0.3s ease;
        }
        .flow-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Custom Scrollbar for Matrix Table */
        .matrix-scroll::-webkit-scrollbar {
            height: 8px;
        }
        .matrix-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .matrix-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
    </style>

    <!-- Application Structure Plan: 
         1. Header: Context & Objective.
         2. Simulation Control: Input for Budget (B).
         3. Dashboard KPIs: High-level metrics (Total, Status, Dominant Category).
         4. Visualizations: Line Chart (Daily vs Threshold), Bar Chart (Categories).
         5. Data Matrix: View of the raw data provided in PDF with dynamic highlighting.
         6. Logic Explorer: Interactive HTML-based flowcharts explaining the algorithms.
         7. Generated Report: Textual output matching the project requirements.
    -->
    
    <!-- Visualization & Content Choices:
         - Metrics Cards: Instant feedback on Budget Status (Goal: Inform).
         - Line Chart: Visualizing Daily Expenses vs 0.20B Threshold (Goal: Change/Monitor).
         - Bar Chart: Comparing Categories (Goal: Compare).
         - Data Matrix: Tabular view to validate specific data points (Goal: Analyze).
         - Logic Flow: Visual blocks to explain the Python logic (Goal: Teach).
         - Dynamic Text: Recommendations based on logic (Goal: Synthesize).
    -->

    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="antialiased pb-12">

    <!-- 1. Header & Context -->
    <header class="bg-white border-b border-stone-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col sm:flex-row justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Proyecto Integrador: Control de Gastos</h1>
                <p class="text-sm text-slate-500">Grupo 03 - Fundamentos de Programación (Python)</p>
            </div>
            <div class="mt-4 sm:mt-0 text-right hidden sm:block">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    Semana de Análisis
                </span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 space-y-12">

        <!-- Intro Section -->
        <section>
            <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-6 md:p-8">
                <h2 class="text-lg font-semibold text-slate-800 mb-2">Contexto del Proyecto</h2>
                <p class="text-slate-600 leading-relaxed">
                    Este panel interactivo simula el programa en Python solicitado para el <strong>Control de Gastos Personales</strong>. 
                    Analiza una matriz de gastos de 7 días x 5 categorías para detectar patrones de consumo, validar el presupuesto semanal ($B$) 
                    y generar alertas automáticas. Utilice los controles a continuación para simular diferentes escenarios presupuestarios.
                </p>
            </div>
        </section>

        <!-- 2. Simulation Control & KPIs -->
        <section class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Control Panel -->
            <div class="lg:col-span-1 bg-stone-100 rounded-xl p-6 border border-stone-200 h-fit">
                <h3 class="text-sm font-bold text-stone-500 uppercase tracking-wider mb-4">Configuración</h3>
                
                <div class="mb-6">
                    <label for="budgetInput" class="block text-sm font-medium text-slate-700 mb-2">
                        Presupuesto Semanal (B) USD
                    </label>
                    <div class="relative mt-1 rounded-md shadow-sm">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <span class="text-gray-500 sm:text-sm">$</span>
                        </div>
                        <input type="number" id="budgetInput" name="budget" value="60.00" min="1" step="0.5"
                            class="block w-full rounded-md border-gray-300 pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 py-2 border text-lg font-semibold text-slate-900"
                            placeholder="0.00">
                    </div>
                    <p class="mt-2 text-xs text-slate-500">
                        Valor predeterminado: $60.00. Modifique para ver cómo cambian las alertas.
                    </p>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500">Umbral Alerta Diaria (0.20B):</span>
                        <span id="dailyThresholdVal" class="font-medium text-slate-800">$12.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500">Límite Seguridad (0.90B):</span>
                        <span id="safetyLimitVal" class="font-medium text-slate-800">$54.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500">Límite Riesgo (1.25B):</span>
                        <span id="riskLimitVal" class="font-medium text-slate-800">$75.00</span>
                    </div>
                </div>

                <div id="riskWarningBox" class="hidden mt-6 bg-red-50 border border-red-200 rounded-lg p-3">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 text-2xl">⚠️</div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Riesgo Financiero</h3>
                            <p class="text-xs text-red-700 mt-1">Gasto semanal supera 1.25B. Se recomienda detener gastos inmediatamente (break).</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Card 1: Total Expense -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 flex flex-col justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Gasto Total Semanal</p>
                        <p id="totalWeeklyExpense" class="text-3xl font-bold text-slate-900 mt-2">$0.00</p>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="expenseProgressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="expenseProgressText" class="text-xs text-slate-500 mt-1 text-right">0% del Presupuesto</p>
                    </div>
                </div>

                <!-- Card 2: Status -->
                <div id="statusCard" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 flex flex-col justify-between transition-colors duration-300">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Estado del Presupuesto</p>
                        <p id="budgetStatusText" class="text-2xl font-bold text-slate-900 mt-2">--</p>
                    </div>
                    <p id="budgetStatusDesc" class="text-xs text-slate-600 mt-2">
                        Calculado con lógica if/elif.
                    </p>
                </div>

                <!-- Card 3: Dominant Category -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 flex flex-col justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Categoría Dominante</p>
                        <p id="dominantCategoryText" class="text-xl font-bold text-slate-900 mt-2">--</p>
                    </div>
                    <div class="flex items-center mt-2">
                        <span id="dominantCategoryAmount" class="text-sm font-semibold text-slate-700 mr-2">$0.00</span>
                        <span class="text-xs text-slate-400">(Mayor gasto acumulado)</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Visualizations -->
        <section>
            <div class="mb-6">
                <h2 class="text-xl font-bold text-slate-800">Visualización de Resultados</h2>
                <p class="text-slate-600 mt-1 max-w-3xl">
                    Gráficas generadas dinámicamente con librerías JS (equivalente a <code>matplotlib</code> en Python). 
                    Observe cómo la línea de umbral roja se mueve al ajustar el presupuesto.
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Line Chart: Daily Expenses -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <h3 class="text-sm font-semibold text-slate-700 mb-4">Gasto Total Diario vs. Alerta (0.20B)</h3>
                    <div class="chart-container">
                        <canvas id="dailyLineChart"></canvas>
                    </div>
                    <p class="text-xs text-slate-400 mt-4 text-center">
                        Puntos rojos indican días donde se superó el umbral de alerta diario.
                    </p>
                </div>

                <!-- Bar Chart: Categories -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <h3 class="text-sm font-semibold text-slate-700 mb-4">Gasto Acumulado por Categoría</h3>
                    <div class="chart-container">
                        <canvas id="categoryBarChart"></canvas>
                    </div>
                    <p class="text-xs text-slate-400 mt-4 text-center">
                        Muestra en qué rubros se está concentrando el gasto.
                    </p>
                </div>
            </div>
        </section>

        <!-- 4. Data Matrix & Report -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Raw Matrix Table -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                <div class="p-6 border-b border-stone-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">Matriz de Gastos (7x5)</h3>
                    <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">Datos del PDF</span>
                </div>
                <div class="p-0 overflow-x-auto matrix-scroll">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-stone-50">
                            <tr>
                                <th class="px-4 py-3">Día</th>
                                <th class="px-4 py-3 text-right">Alim.</th>
                                <th class="px-4 py-3 text-right">Trans.</th>
                                <th class="px-4 py-3 text-right">Mat.</th>
                                <th class="px-4 py-3 text-right">Entr.</th>
                                <th class="px-4 py-3 text-right">Otros</th>
                                <th class="px-4 py-3 text-right font-bold bg-stone-100">Total</th>
                            </tr>
                        </thead>
                        <tbody id="matrixBody" class="divide-y divide-stone-100">
                            <!-- JS will populate rows -->
                        </tbody>
                    </table>
                </div>
                <div class="p-4 bg-stone-50 border-t border-stone-100 text-xs text-slate-500">
                    * Filas resaltadas en <span class="text-amber-600 font-bold">naranja</span> indican días con alerta de gasto (> 0.20B).
                </div>
            </div>

            <!-- Text Report Generation -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-stone-200 flex flex-col">
                <h3 class="font-bold text-slate-800 mb-4">Informe Automático</h3>
                <div id="textReport" class="flex-grow bg-slate-50 rounded-lg p-4 font-mono text-xs text-slate-700 leading-relaxed overflow-y-auto max-h-96 border border-slate-200">
                    Generando reporte...
                </div>
                <button onclick="downloadReport()" class="mt-4 w-full bg-slate-800 hover:bg-slate-700 text-white py-2 px-4 rounded-md text-sm transition-colors">
                    Simular Descarga .txt
                </button>
            </div>
        </section>

        <!-- 5. Logic Flow Explorer (Educational) -->
        <section>
            <div class="mb-8">
                <h2 class="text-xl font-bold text-slate-800">Lógica del Algoritmo</h2>
                <p class="text-slate-600 mt-1">
                    Representación visual del flujo de control y las funciones principales solicitadas en el informe técnico.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Main Algorithm Flow -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <h3 class="text-sm font-bold text-indigo-600 uppercase mb-6">Algoritmo General (Bucle Principal)</h3>
                    
                    <div class="flex flex-col items-center text-sm space-y-0">
                        <!-- Start -->
                        <div class="flow-box bg-slate-100 px-4 py-2 rounded-full border border-slate-300 font-medium">Inicio</div>
                        
                        <!-- Input -->
                        <div class="flow-arrow"></div>
                        <div class="flow-box bg-blue-50 px-4 py-3 rounded border border-blue-200 text-center w-full max-w-xs">
                            <span class="font-bold text-blue-800">Entrada:</span> Presupuesto (B)<br>
                            <span class="text-xs text-blue-600">Validar B > 0 (while)</span>
                        </div>

                        <!-- Process Loop -->
                        <div class="flow-arrow"></div>
                        <div class="flow-box bg-amber-50 px-4 py-3 rounded border border-amber-200 text-center w-full max-w-xs relative">
                            <span class="font-bold text-amber-800">Recorrer Matriz (for)</span>
                            <div class="my-2 text-xs text-left pl-4 space-y-1 text-amber-900">
                                <p>• ¿Gasto < 0? → <span class="font-mono bg-amber-100 px-1">continue</span></p>
                                <p>• Acumular Totales</p>
                                <p>• ¿Total > 1.25B? → <span class="font-mono bg-red-100 text-red-700 px-1">break</span></p>
                            </div>
                        </div>

                        <!-- Classify -->
                        <div class="flow-arrow"></div>
                        <div class="flow-box bg-purple-50 px-4 py-3 rounded border border-purple-200 text-center w-full max-w-xs">
                            <span class="font-bold text-purple-800">Función:</span> clasificar_presupuesto()<br>
                            <span class="text-xs text-purple-600">if / elif / else</span>
                        </div>

                        <!-- Output -->
                        <div class="flow-arrow"></div>
                        <div class="flow-box bg-green-50 px-4 py-3 rounded border border-green-200 text-center w-full max-w-xs">
                            <span class="font-bold text-green-800">Salida:</span> Gráficos y Reporte
                        </div>
                    </div>
                </div>

                <!-- Classification Function Logic -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <h3 class="text-sm font-bold text-teal-600 uppercase mb-6">Lógica de Clasificación</h3>
                    
                    <div class="space-y-4">
                        <!-- Condition 1 -->
                        <div class="flex items-center group">
                            <div class="w-1/3 text-right pr-4 font-mono text-xs text-slate-500">if Total <= 0.90B</div>
                            <div class="w-2/3 bg-green-50 border border-green-200 p-3 rounded hover:bg-green-100 transition-colors">
                                <h4 class="font-bold text-green-800 text-sm">Bajo Control</h4>
                                <p class="text-xs text-green-700">Situación ideal. Ahorro recomendado.</p>
                            </div>
                        </div>

                        <!-- Condition 2 -->
                        <div class="flex items-center group">
                            <div class="w-1/3 text-right pr-4 font-mono text-xs text-slate-500">elif Total < B</div>
                            <div class="w-2/3 bg-orange-50 border border-orange-200 p-3 rounded hover:bg-orange-100 transition-colors">
                                <h4 class="font-bold text-orange-800 text-sm">En Alerta</h4>
                                <p class="text-xs text-orange-700">Cerca del límite. Precaución requerida.</p>
                            </div>
                        </div>

                        <!-- Condition 3 -->
                        <div class="flex items-center group">
                            <div class="w-1/3 text-right pr-4 font-mono text-xs text-slate-500">else</div>
                            <div class="w-2/3 bg-red-50 border border-red-200 p-3 rounded hover:bg-red-100 transition-colors">
                                <h4 class="font-bold text-red-800 text-sm">Excedido</h4>
                                <p class="text-xs text-red-700">Presupuesto superado. Revisar categoría dominante.</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 p-4 bg-stone-50 rounded text-xs text-slate-500 italic border border-stone-100">
                        Esta lógica se ejecuta automáticamente cada vez que cambia el valor del presupuesto en el panel superior.
                    </div>
                </div>

            </div>
        </section>

    </main>

    <footer class="bg-slate-800 text-slate-300 py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm">Proyecto de Fundamentos de Programación • Ciencia de Datos e IA</p>
            <p class="text-xs mt-2 text-slate-500">Generado para simulación interactiva SPA</p>
        </div>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA & STATE ---
        // Matrix data from PDF Page 2
        // Rows: Days 1-7
        // Cols: Alimentación, Transporte, Materiales, Entretenimiento, Otros
        const CATEGORIES = ["Alimentación", "Transporte", "Materiales", "Entretenimiento", "Otros"];
        const RAW_MATRIX = [
            [4.50, 1.20, 0.00, 2.50, 0.80], // Dia 1
            [3.90, 1.20, 1.50, 0.00, 0.60], // Dia 2
            [5.10, 1.20, 0.00, 3.00, 0.00], // Dia 3
            [4.20, 1.20, 0.80, 0.00, 1.10], // Dia 4
            [6.00, 1.20, 0.00, 4.50, 0.00], // Dia 5
            [4.80, 1.20, 1.00, 0.00, 0.50], // Dia 6
            [5.50, 1.20, 0.00, 2.00, 0.90]  // Dia 7
        ];

        let state = {
            budget: 60.00,
            dailyTotals: [],
            categoryTotals: [],
            weeklyTotal: 0,
            status: "",
            dominantCategoryIdx: 0,
            riskBreak: false, // Tracks if 1.25B loop break occurred
            daysWithAlert: [] // Indices of days > 0.20B
        };

        // Chart Instances
        let lineChartInstance = null;
        let barChartInstance = null;

        // --- CORE FUNCTIONS (Mimicking Python Logic) ---

        function calculateMetrics() {
            // Reset totals
            state.dailyTotals = new Array(7).fill(0);
            state.categoryTotals = new Array(5).fill(0);
            state.weeklyTotal = 0;
            state.daysWithAlert = [];
            state.riskBreak = false;

            const riskThreshold = state.budget * 1.25;
            const dailyAlertThreshold = state.budget * 0.20;

            // Loop Logic with Break/Continue Simulation
            // We process the whole matrix but flag if we 'would have' broken
            let accumulatedForBreakCheck = 0;

            // 1. Calculate Daily Totals & Category Totals
            for (let i = 0; i < RAW_MATRIX.length; i++) { // Days
                let dailySum = 0;
                for (let j = 0; j < RAW_MATRIX[i].length; j++) { // Categories
                    const val = RAW_MATRIX[i][j];
                    
                    // Simulate 'continue' for negative values (though data is clean)
                    if (val < 0) continue; 

                    dailySum += val;
                    state.categoryTotals[j] += val;
                }
                state.dailyTotals[i] = dailySum;
                
                // Check Daily Alert
                if (dailySum > dailyAlertThreshold) {
                    state.daysWithAlert.push(i);
                }

                // Check Risk Break
                accumulatedForBreakCheck += dailySum;
                if (accumulatedForBreakCheck > riskThreshold && !state.riskBreak) {
                    state.riskBreak = true;
                    // In a real python script, we would 'break' here. 
                    // For the dashboard, we continue calculating to show full data, 
                    // but we will trigger the UI warning.
                }
            }

            state.weeklyTotal = state.dailyTotals.reduce((a, b) => a + b, 0);

            // 2. Dominant Category
            let maxCatVal = -1;
            state.categoryTotals.forEach((val, idx) => {
                if (val > maxCatVal) {
                    maxCatVal = val;
                    state.dominantCategoryIdx = idx;
                }
            });

            // 3. Classify Budget (Function clasificar_presupuesto)
            if (state.weeklyTotal <= 0.90 * state.budget) {
                state.status = "Bajo control";
            } else if (state.weeklyTotal <= state.budget) {
                state.status = "En alerta";
            } else {
                state.status = "Excedido";
            }
        }

        // --- UI UPDATES ---

        function updateUI() {
            // Update Threshold Texts
            document.getElementById('dailyThresholdVal').innerText = `$${(state.budget * 0.20).toFixed(2)}`;
            document.getElementById('safetyLimitVal').innerText = `$${(state.budget * 0.90).toFixed(2)}`;
            document.getElementById('riskLimitVal').innerText = `$${(state.budget * 1.25).toFixed(2)}`;

            // Update KPI Cards
            document.getElementById('totalWeeklyExpense').innerText = `$${state.weeklyTotal.toFixed(2)}`;
            
            // Progress Bar
            const percent = Math.min((state.weeklyTotal / state.budget) * 100, 100);
            const progressBar = document.getElementById('expenseProgressBar');
            const progressText = document.getElementById('expenseProgressText');
            
            progressBar.style.width = `${percent}%`;
            progressText.innerText = `${(state.weeklyTotal / state.budget * 100).toFixed(1)}% del Presupuesto`;

            // Status Card Styling
            const statusCard = document.getElementById('statusCard');
            const statusText = document.getElementById('budgetStatusText');
            
            statusText.innerText = state.status;
            
            // Remove old color classes
            statusCard.classList.remove('bg-green-50', 'border-green-200', 'bg-orange-50', 'border-orange-200', 'bg-red-50', 'border-red-200');
            
            if (state.status === "Bajo control") {
                statusCard.classList.add('bg-green-50', 'border-green-200');
                progressBar.classList.remove('bg-amber-500', 'bg-red-600');
                progressBar.classList.add('bg-emerald-500');
            } else if (state.status === "En alerta") {
                statusCard.classList.add('bg-orange-50', 'border-orange-200');
                progressBar.classList.remove('bg-emerald-500', 'bg-red-600');
                progressBar.classList.add('bg-amber-500');
            } else {
                statusCard.classList.add('bg-red-50', 'border-red-200');
                progressBar.classList.remove('bg-emerald-500', 'bg-amber-500');
                progressBar.classList.add('bg-red-600');
            }

            // Dominant Category
            document.getElementById('dominantCategoryText').innerText = CATEGORIES[state.dominantCategoryIdx];
            document.getElementById('dominantCategoryAmount').innerText = `$${state.categoryTotals[state.dominantCategoryIdx].toFixed(2)}`;

            // Risk Warning Box
            const warningBox = document.getElementById('riskWarningBox');
            if (state.riskBreak) {
                warningBox.classList.remove('hidden');
            } else {
                warningBox.classList.add('hidden');
            }

            // Update Matrix Table
            renderMatrixTable();
            
            // Update Report Text
            generateTextReport();

            // Update Charts
            updateCharts();
        }

        function renderMatrixTable() {
            const tbody = document.getElementById('matrixBody');
            tbody.innerHTML = '';
            
            RAW_MATRIX.forEach((row, dayIdx) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-stone-50 transition-colors";
                
                // Highlight row if Daily Alert triggered
                const isAlert = state.daysWithAlert.includes(dayIdx);
                if (isAlert) {
                    tr.classList.add('bg-amber-50');
                }

                // Day Cell
                const dayCell = document.createElement('td');
                dayCell.className = "px-4 py-3 font-medium text-slate-900 whitespace-nowrap";
                dayCell.innerHTML = `Día ${dayIdx + 1} ${isAlert ? '<span class="text-amber-600 ml-1">⚠️</span>' : ''}`;
                tr.appendChild(dayCell);

                // Category Cells
                row.forEach(val => {
                    const td = document.createElement('td');
                    td.className = "px-4 py-3 text-right";
                    td.innerText = val.toFixed(2);
                    tr.appendChild(td);
                });

                // Total Cell
                const totalCell = document.createElement('td');
                totalCell.className = `px-4 py-3 text-right font-bold ${isAlert ? 'text-amber-700' : 'text-slate-900'} bg-stone-50/50`;
                totalCell.innerText = state.dailyTotals[dayIdx].toFixed(2);
                tr.appendChild(totalCell);

                tbody.appendChild(tr);
            });
        }

        function generateTextReport() {
            const reportDiv = document.getElementById('textReport');
            const date = new Date().toLocaleDateString();
            
            let content = `INFORME DE GASTOS SEMANALES\nFecha: ${date}\n--------------------------------\n`;
            content += `Presupuesto Base (B): $${state.budget.toFixed(2)}\n`;
            content += `Gasto Total Real:     $${state.weeklyTotal.toFixed(2)}\n`;
            content += `Estado Financiero:    ${state.status.toUpperCase()}\n\n`;
            
            content += `DETALLE DIARIO:\n`;
            state.dailyTotals.forEach((tot, i) => {
                const alertMark = state.daysWithAlert.includes(i) ? " [ALERTA > 0.20B]" : "";
                content += `Día ${i+1}: $${tot.toFixed(2)}${alertMark}\n`;
            });
            
            content += `\nDETALLE POR CATEGORÍA:\n`;
            state.categoryTotals.forEach((tot, i) => {
                content += `${CATEGORIES[i].padEnd(18)}: $${tot.toFixed(2)}\n`;
            });

            content += `\nCONCLUSIÓN:\n`;
            if (state.status === "Bajo control") {
                content += `Gestión eficiente. El gasto está por debajo del 90% del presupuesto.`;
            } else if (state.status === "En alerta") {
                content += `Precaución. El gasto está entre el 90% y el 100% del presupuesto.`;
            } else {
                content += `CRÍTICO. Se ha excedido el presupuesto en $${(state.weeklyTotal - state.budget).toFixed(2)}.`;
                content += `\nRecomendación: Reducir gastos en '${CATEGORIES[state.dominantCategoryIdx]}'.`;
            }

            if(state.riskBreak) {
                content += `\n\n*** RIESGO FINANCIERO DETECTADO ***\nEl gasto acumulado superó el límite de seguridad de 1.25B.`;
            }

            reportDiv.innerText = content;
        }

        // --- CHART CONFIGURATION ---

        function initCharts() {
            // 1. Line Chart
            const ctxLine = document.getElementById('dailyLineChart').getContext('2d');
            lineChartInstance = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: ['Día 1', 'Día 2', 'Día 3', 'Día 4', 'Día 5', 'Día 6', 'Día 7'],
                    datasets: [
                        {
                            label: 'Gasto Diario',
                            data: [],
                            borderColor: '#3b82f6', // Blue-500
                            backgroundColor: '#3b82f6',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            tension: 0.3
                        },
                        {
                            label: 'Umbral Alerta (0.20B)',
                            data: [], // Will be flat line
                            borderColor: '#ef4444', // Red-500
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'USD ($)' }
                        }
                    }
                }
            });

            // 2. Bar Chart
            const ctxBar = document.getElementById('categoryBarChart').getContext('2d');
            barChartInstance = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: CATEGORIES,
                    datasets: [{
                        label: 'Gasto Acumulado',
                        data: [],
                        backgroundColor: [
                            '#fbbf24', // Amber
                            '#60a5fa', // Blue
                            '#a78bfa', // Purple
                            '#f472b6', // Pink
                            '#94a3b8'  // Slate
                        ],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'USD ($)' }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            const threshold = state.budget * 0.20;
            
            // Update Line Chart
            lineChartInstance.data.datasets[0].data = state.dailyTotals;
            lineChartInstance.data.datasets[1].data = new Array(7).fill(threshold);
            
            // Dynamic point coloring for Line Chart (Red if above threshold)
            lineChartInstance.data.datasets[0].pointBackgroundColor = state.dailyTotals.map(val => 
                val > threshold ? '#ef4444' : '#3b82f6'
            );
            lineChartInstance.data.datasets[0].pointBorderColor = state.dailyTotals.map(val => 
                val > threshold ? '#ef4444' : '#3b82f6'
            );

            lineChartInstance.update();

            // Update Bar Chart
            barChartInstance.data.datasets[0].data = state.categoryTotals;
            barChartInstance.update();
        }

        // --- EVENT LISTENERS & INIT ---

        document.getElementById('budgetInput').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if (!isNaN(val) && val > 0) {
                state.budget = val;
                calculateMetrics();
                updateUI();
            }
        });

        // Simula la descarga
        function downloadReport() {
            const text = document.getElementById('textReport').innerText;
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', 'reporte_gastos_grupo03.txt');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // Initialize
        window.addEventListener('load', () => {
            initCharts();
            calculateMetrics();
            updateUI();
        });

    </script>
</body>
</html>